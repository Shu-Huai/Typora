# IPv6

## 什么是 IPv6

**IPv6**（Internet Protocol version 6）是**互联网协议**（IP）的第六版，是目前广泛使用的协议版本之一。它主要用于**网络中设备间的通信**，特别是在 **IP 网络中标识和定位设备**。IPv6 是 IPv4 的继任者，主要是为了应对 IPv4 地址耗尽的问题，并为未来的互联网发展提供更大的地址空间和更先进的特性。

### **IPv6 主要特点**

1. **更大的地址空间**：
    - IPv6 提供了 **128 位** 地址，允许为全球每个设备分配一个唯一的地址，理论上可以支持**约 340 万亿个地址**。
    - 对比 IPv4 的 **32 位** 地址，IPv6 能提供更广泛的地址分配，避免了 IPv4 地址枯竭的问题。
    - IPv6 地址通常表示为 **8组 4 个十六进制数字**，每组用冒号（:）分隔。例如：`2001:0db8:85a3:0000:0000:8a2e:0370:7334`
2. **自动地址配置（SLAAC）**：
    - IPv6 支持**无状态自动配置**（SLAAC），设备可以无需手动配置或依赖 DHCP 服务器，自动生成自己的 IPv6 地址。
    - 设备通过接收到的路由器通告消息（Router Advertisement，RA）来自动配置地址，简化了设备的接入过程。
3. **消除了 NAT（网络地址转换）需求**：
    - IPv6 由于其地址空间巨大，几乎每个设备都可以分配一个**公共的、全球唯一的 IP 地址**，因此无需像 IPv4 那样使用 **NAT（Network Address Translation）** 来共享地址。
    - 这不仅解决了 IPv4 地址短缺问题，还减少了 NAT 带来的网络性能和配置复杂性问题。
4. **更高效的路由和数据传输**：
    - IPv6 对路由和数据传输进行了优化，简化了头部的结构，提高了网络数据包的处理效率。
    - 它还支持**多播通信**（Multicast），比 IPv4 的广播通信更为高效。
5. **内置安全性**：
    - **IPsec** 是 IPv6 的一部分，提供端到端的加密和认证，增强了通信的安全性。
    - 尽管 IPv4 也可以实现 IPsec，但 IPv6 原生支持这一特性，提高了网络安全性。
6. **支持更高效的移动通信**：
    - IPv6 为**移动设备**提供了更好的支持，尤其是在处理**移动性管理**和地址转换时。设备在网络中移动时，其 IPv6 地址可以保持不变，实现更流畅的通信。

## IPv6 地址格式

IPv6 地址由 **128 位**二进制数字组成，通常以 **8组 4位十六进制数**的形式表示，每组用冒号（:）分隔。例如：

```
2001:0db8:85a3:0000:0000:8a2e:0370:7334
```

为了简化书写，IPv6 地址可以通过以下方式压缩：

- 去掉前导零：每组中的前导零可以省略。

    - 例如：`0000` 可以写作 `0`。

- 使用双冒号（::）替代连续的零组

    每个 IPv6 地址中只能使用一次双冒号。

    - 例如：`2001:0db8:0000:0000:0000:0000:8a2e:0370` 可以简化为 `2001:0db8::8a2e:0370`。

## 子网划分

在 IPv6 中，**子网划分**通过网络前缀和掩码（类似于 IPv4 中的子网掩码）来确定。IPv6 地址总共有 **128 位**，其中一部分用于网络前缀（网络部分），另一部分用于设备地址（主机部分）。

### **IPv6 地址结构**

IPv6 地址的结构可以通过以下方式理解：

- **前缀部分**（Network prefix）：这部分标识网络，通常由 ISP 或组织分配。
- **主机部分**（Host part）：这部分标识在特定子网内的设备。

例如，IPv6 地址 `2001:0db8:85a3:0000:0000:8a2e:0370:7334/64` 中，`2001:0db8:85a3:0000` 是前缀，`/64` 表示前 64 位用于网络标识，剩余的 64 位用于主机标识。

### **IPv6 子网划分步骤**

1. **选择合适的网络前缀**：
    - IPv6 地址分配通常以 **/64** 为单位，即前 64 位用于网络前缀，剩余的 64 位用于主机地址。这意味着每个子网有 **18.4 × 10¹⁸** 个可用地址，因此这种划分足够满足大多数应用需求。
    - **例子**：
        - `2001:0db8:85a3:0000::/64` 是一个典型的 IPv6 子网，表示该网络的前缀为 `2001:0db8:85a3:0000`，并且设备地址部分由剩余的 64 位组成。
2. **划分子网**：
    - 如果需要划分更多的子网，可以通过修改前缀长度（网络部分的位数）来实现。例如，使用 `/64` 划分子网时，如果希望将其进一步划分为多个子网，可以考虑使用 `/72` 或 `/80` 等更小的前缀。
    - **例子**：
        - 你有 `2001:0db8:85a3:0000::/64` 这样的前缀，想要将其划分成 4 个子网，可以选择 `2001:0db8:85a3:0000::/66`、`2001:0db8:85a3:0001::/66` 等子网前缀。
3. **子网前缀计算**：
    - 通过调整前缀长度，可以控制每个子网中的主机数量。例如：
        - **/64**：每个子网有 18.4 × 10¹⁸ 个地址。
        - **/72**：每个子网有约 4.6 × 10¹² 个地址。
        - **/80**：每个子网有 1.15 × 10⁶ 个地址。
4. **选择适当的子网掩码**：
    - 子网掩码在 IPv6 中通过前缀长度（如 `/64`）表示，前缀长度指明了网络部分的长度。例如，`/64` 表示前 64 位是网络部分，剩余的 64 位是主机部分。

### IPv6 子网划分常见前缀长度

- **/64**：最常用的 IPv6 子网前缀，通常用作每个局部网络的子网。
- **/48**：适用于大型组织的地址分配，通常会被分配给一个站点或大型企业网络，允许其进一步划分子网。
- **/56**：通常分配给中小型企业，允许进一步划分多个子网。
- **/128**：用于单个设备的地址，通常用于指定设备的唯一标识符。

## 地址分类

### **本地地址（Link-local Addresses）**

- **定义**：本地地址是仅在本地网络或链路上有效的 IPv6 地址。它们用于同一网络中的设备之间的通信，不能跨越路由器或网络边界。
- **前缀**：本地地址的前缀是 **`fe80::/10`**，但通常会被简写为 **`fe80::`**。
- **作用**：
    - 本地地址通常用于设备在同一网络段内进行通信。即使没有全球可路由的地址，设备仍然可以通过本地地址与同一网络中的其他设备进行通信。
    - 设备初始化时会自动配置一个本地地址，甚至在没有网络连接的情况下，设备也可以利用本地地址与邻居设备进行通信（例如，IPv6 的**邻居发现协议**）。
    - 本地地址用于**自动配置**、**邻居发现**、**路由选择**等网络操作。
- **示例**：
    - 一个典型的本地地址示例为：`fe80::1a2b:3c4d:5e6f:7g8h`
- **特性**：
    - **不可路由**：本地地址仅在同一链路上有效，不能通过路由器转发，因此它们不会被传播到其他子网。
    - **自动配置**：设备通过 SLAAC（无状态地址自动配置）机制自动生成本地地址。

### 全球地址（Global Addresses）

- **定义**：全球地址是可以在整个 IPv6 网络中路由的地址，可以跨越不同的网络和路由器进行通信。全球地址通常是通过**ISP**（互联网服务提供商）分配的，并且是**唯一**的。
- **前缀**：全球地址的前缀通常是 **`2000::/3`**，也就是以 `2` 或 `3` 开头的地址范围。例如，`2001:0db8::` 就是一个常见的全球地址前缀。
- **作用**
    - 全球地址用于设备之间在不同网络之间的通信，是**全球唯一的**，通常通过 DHCPv6 或 SLAAC 分配。
    - 通过全球地址，设备能够与互联网或广域网中的其他设备进行通信。
- **示例**
    - 一个典型的全球地址示例为：`2001:0db8:85a3:0000:0000:8a2e:0370:7334`
- **特性**
    - **可路由**：全球地址是**全球可路由**的，能够跨越路由器、ISP 以及全球各地的网络进行通信。
    - **唯一性**：全球地址是全球唯一的，确保每个设备能够在全球范围内被唯一标识和通信。

### 其他类型的地址

除了本地地址和全球地址，IPv6 还包括以下几种类型的地址：

- **多播地址（Multicast Addresses）**：
    - 多播地址用于向多个设备发送数据，支持一对多或多对多的通信。多播地址的前缀是 **`ff00::/8`**。
- **任播地址（Anycast Addresses）**：
    - 任播地址是一种特殊类型的地址，它允许数据包送往最近的多个设备中的任意一个设备。任播地址不需要特定的前缀，但其用法在网络中相对较少。
- **单播地址（Unicast Addresses）**：
    - 单播地址是最常见的地址类型，它是指数据包从一个源设备发送到一个目标设备的地址，包含了本地地址和全球地址。

## IPv6 数据报格式

IPv6 数据报格式（Packet Format）与 IPv4 相比进行了简化和优化。IPv6 的数据报格式包含了**固定头部**和**可选的扩展头部**。

![在这里插入图片描述](http://public.file.lvshuhuai.cn/images\b3a7d9ab5975accf8c3350897bcf74bb.png)

### IPv6 数据报结构

IPv6 数据报主要由两个部分组成：

1. **固定头部**（Fixed Header）
2. **扩展头部**（Extension Headers，选项部分）
3. **有效载荷**（Payload，包含数据）

#### IPv6 固定头部（Fixed Header）

IPv6 固定头部是每个 IPv6 数据报的必备部分，其格式如下：

| 字段名                              | 长度 (位) | 描述                                                         |
| ----------------------------------- | --------- | ------------------------------------------------------------ |
| **版本（Version）**                 | 4 位      | 表示 IPv6 协议的版本号，固定值为 `6`。                       |
| **流标签（Traffic Class）**         | 8 位      | 用于流量分类和优先级处理，与 IPv4 的服务类型（Type of Service，TOS）类似。 |
| **流量标识符（Flow Label）**        | 20 位     | 用于标识数据流，提供端到端的服务质量（QoS）保证。            |
| **有效载荷长度（Payload Length）**  | 16 位     | 包含 IPv6 数据报的有效载荷的长度，单位是字节（不包括头部）。 |
| **下一个头部（Next Header）**       | 8 位      | 指示下一个头部的类型（例如 TCP、UDP、ICMPv6 或扩展头部）。   |
| **跳数限制（Hop Limit）**           | 8 位      | 限制数据包可以经过的路由器的数量（类似于 IPv4 的 TTL）。     |
| **源地址（Source Address）**        | 128 位    | 发送数据报的设备的 IPv6 地址。                               |
| **目的地址（Destination Address）** | 128 位    | 接收数据报的设备的 IPv6 地址。                               |

#### IPv6 扩展头部（Optional Extension Headers）

IPv6 允许通过扩展头部来处理一些特殊的功能，扩展头部位于固定头部之后。扩展头部并不是每个 IPv6 数据包都需要的，它们是根据需要附加的。这些扩展头部可以包含多种类型，如：

1. 路由头部（Routing Header）
    - 路由头部用于携带经过的路由节点信息，以便数据包可以在特定的路径上传输。
2. 分段头部（Fragment Header）
    - 如果数据报需要分段（例如，当数据包的大小超过了网络的最大传输单元（MTU）），分段头部会将数据报分割成多个较小的数据报段，并提供重组信息。
3. 目标端口头部（Destination Option Header）
    - 目标端口头部可以用于提供目标主机所需的特定控制信息。
4. 源端口头部（Source Option Header）
    - 类似于目标端口头部，用于源主机传递附加信息。
5. ICMPv6 头部
    - 如果数据包携带 ICMPv6 消息（例如，ping 请求），则包含 ICMPv6 头部。

扩展头部通常是 **按需** 添加的，在固定头部之后依次排列，直到有效载荷数据开始。

#### IPv6 数据报有效载荷（Payload）

有效载荷部分包含了真正的数据内容，比如传输的 **TCP/UDP 数据**或 **ICMPv6 消息**。有效载荷的长度由固定头部中的**有效载荷长度**字段指定。

## IPv6 与 IPv4 的区别

| 特性             | **IPv4**                            | **IPv6**                                  |
| ---------------- | ----------------------------------- | ----------------------------------------- |
| **地址长度**     | 32 位                               | 128 位                                    |
| **地址表示**     | 十进制点分格式（例如：192.168.0.1） | 十六进制冒号分隔格式（例如：2001:db8::1） |
| **地址总量**     | 大约 43 亿个地址                    | 大约 340 万亿个地址                       |
| **地址配置方式** | DHCP、手动配置、NAT                 | SLAAC（无状态自动配置）、DHCPv6           |
| **路由优化**     | 路由表较大                          | 路由表优化，结构简单                      |
| **内置安全性**   | 可选（IPsec 需要手动配置）          | 强制内置 IPsec 支持                       |
| **支持的协议**   | IPv4                                | IPv6                                      |
| **多播和广播**   | 支持广播、单播、多播                | 支持多播和单播，不支持广播                |

## IPv6 的应用和前景

- **Internet of Things (IoT)**：随着设备数量的激增，IPv6 为物联网（IoT）设备提供了足够的地址，确保每个设备都能连接到互联网。
- **智能城市、自动驾驶、智能家居等**：这些领域需要大量的设备连接，IPv6 提供了足够的地址和高效的通信能力。
- **全球互联网普及**：IPv6 使得全球每个设备都能拥有独特的地址，促进了全球互联网的扩展。

## IPv6 地址的获取方式

IPv6 地址的获取方式主要有三种，分别是 **SLAAC（Stateless Address Autoconfiguration）**、**DHCPv6（Dynamic Host Configuration Protocol for IPv6）** 和 **手动配置**

### SLAAC（Stateless Address Autoconfiguration）

- **原理**：
    - SLAAC 是一种**无状态的自动配置**方法，不需要 DHCP 服务器。设备通过路由器发送的**路由器通告（RA）消息**来自动生成 IPv6 地址。
    - 路由器通告消息中包含前缀信息，设备可以根据此前缀和自己的 MAC 地址（通过 EUI-64 机制）来生成自己的 IPv6 地址。
    - 地址由 **64 位前缀**和**设备接口的后 64 位**组成，设备通常使用其 MAC 地址来生成唯一的后缀部分。
- **优点**：
    - 简单，自动化程度高。
    - 不需要专门的 DHCPv6 服务器。
    - 广泛用于家庭、移动设备以及简单的网络配置。
- **适用场景**：
    - 家庭网络、Wi-Fi 网络、移动设备等。
- **工作流程**：
    1. 设备启动并发送 **Router Solicitation**（路由器请求）包。
    2. 路由器接收到请求后，回复 **Router Advertisement**（路由器通告）包，提供前缀信息。
    3. 设备根据该前缀和自身 MAC 地址生成 IPv6 地址。

### DHCPv6（Dynamic Host Configuration Protocol for IPv6）

- **原理**：
    - 与 **IPv4 中的 DHCP** 类似，**DHCPv6** 是一种 **有状态配置** 协议，设备向 DHCPv6 服务器请求地址和其他配置信息（如 DNS 服务器地址、网关等）。
    - 设备发送 DHCPv6 请求包，服务器响应并分配一个有效的 IPv6 地址和相关网络配置信息。
    - DHCPv6 服务器通常用于更复杂的网络环境，如企业网络或运营商网络。
- **优点**：
    - 灵活，能够提供详细的配置选项。
    - 可以指定多个 DNS 服务器、网关等信息。
    - 支持有状态管理，可以追踪每个设备的配置。
- **适用场景**：
    - 企业网络、运营商网络、需要管理大量设备的环境。
- **工作流程**：
    1. 设备发送 **DHCPv6 Solicit** 请求包。
    2. DHCPv6 服务器响应，并发送 **Advertise** 包。
    3. 设备发送 **Request** 包，请求地址配置。
    4. 服务器返回 **Reply** 包，分配 IPv6 地址及其他配置信息。

### 手动配置

- **原理**：
    - 设备可以手动配置其 IPv6 地址。这种方式常用于需要精确控制 IP 地址分配的场景，比如服务器或某些特殊设备。
    - 管理员可以在设备的网络设置中直接输入 IPv6 地址、子网掩码、网关和 DNS 服务器等信息。
- **优点**：
    - 完全控制地址配置，适用于需要静态 IP 配置的环境。
    - 没有依赖 DHCP 或 SLAAC，减少了网络中的动态配置过程。
- **适用场景**：
    - 服务器、网络设备、静态配置网络环境等。
- **工作流程**：
    1. 管理员手动为设备设置 IPv6 地址、子网掩码、网关和 DNS 地址等。
    2. 设备根据这些静态配置来进行通信。

### 总结比较

| 配置方式         | SLAAC                                       | DHCPv6                         | 手动配置                             |
| ---------------- | ------------------------------------------- | ------------------------------ | ------------------------------------ |
| **地址类型**     | 无状态（自动生成）                          | 有状态（由服务器分配）         | 静态配置（管理员手动输入）           |
| **依赖服务器**   | 无需 DHCP 服务器，依赖路由器通告            | 需要 DHCPv6 服务器             | 无需服务器，完全由管理员控制         |
| **配置复杂度**   | 低，自动配置，无需人工干预                  | 较高，需要设置 DHCPv6 服务器   | 高，需要手动输入所有信息             |
| **适用场景**     | 家庭网络、移动设备、Wi-Fi 网络              | 企业网络、运营商网络、大型网络 | 静态配置的设备（如服务器、网络设备） |
| **地址生成方式** | 使用路由器前缀和设备 MAC 地址（EUI-64）生成 | 由 DHCPv6 服务器分配           | 手动输入配置                         |

## DNS 获取方式

在 **IPv6** 网络中，DNS 获取方式有几种，主要包括**通过路由器通告（RDNSS）**和 **DHCPv6**

### SLAAC 和 RDNSS（Router Advertisement DNS Server）

**SLAAC** 是一种无状态的自动配置方式，通常用于 IPv6 网络中。通过**路由器通告（RA）**，设备可以自动获取网络的配置信息，包括 **DNS 服务器地址**，这一过程利用 **RDNSS** 扩展来实现。

- **RDNSS** 是一种通过路由器通告消息（RA）向设备提供 DNS 服务器地址的机制。
- **工作原理**：
    1. 设备在加入网络时，首先发送 **Router Solicitation**（路由器请求）消息来询问网络中的路由器。
    2. 路由器收到请求后，会发送 **Router Advertisement**（路由器通告）消息，其中包含 DNS 服务器地址。
    3. 设备从 RA 消息中提取出 DNS 服务器地址，并将其配置为 DNS 服务器。
- **优点**：
    - **无需 DHCPv6 服务器**，通过路由器自动配置 DNS。
    - 适用于小型网络、家庭网络、Wi-Fi 网络等场景。
- **缺点**：
    - 只能提供 DNS 地址信息，不能提供其他详细配置（如网关等）。

### DHCPv6（Dynamic Host Configuration Protocol for IPv6）

**DHCPv6** 是一种有状态的协议，允许设备向 DHCPv6 服务器请求配置参数，包括 **DNS 服务器地址**。它通常用于更复杂的网络中，尤其是那些需要细粒度管理的企业或运营商网络。

- **工作原理**：
    1. 设备通过 **DHCPv6 Solicit** 请求消息向 DHCPv6 服务器发送请求。
    2. DHCPv6 服务器响应设备的请求，并通过 **DHCPv6 Advertise** 消息告知设备可用的配置。
    3. 设备发送 **Request** 消息，要求服务器提供具体的配置（如 IPv6 地址、DNS 服务器等）。
    4. 服务器发送 **Reply** 消息，向设备提供所需的配置（包括 DNS 地址）。
- **优点**：
    - 支持更丰富的配置选项，除了 DNS 地址外，还可以提供其他信息（如 IP 地址、路由信息等）。
    - 适用于大规模的企业或运营商网络。
- **缺点**：
    - 需要配置和维护 DHCPv6 服务器。
    - 相较于 SLAAC，配置过程更为复杂。

### 手动配置 DNS

在某些网络环境中，设备可以通过**手动配置 DNS 服务器地址**来获取 DNS 服务。用户可以在设备的网络设置中直接输入 DNS 服务器的 IP 地址。

- **工作原理**：
    - 用户手动输入 DNS 服务器的 IPv6 地址，设备直接使用该 DNS 服务器进行域名解析。
- **优点**：
    - **完全控制**：用户可以选择任何 DNS 服务器。
    - 适用于需要特定 DNS 配置的环境。
- **缺点**：
    - **需要人工干预**，不适用于动态变化的网络环境。

### DNS64 和 NAT64 配置

**DNS64** 和 **NAT64** 是针对 IPv6-only 网络和 IPv4-only 网络之间互通的解决方案。DNS64 在 IPv6-only 网络中充当 **DNS 服务器**，当需要解析 IPv4 地址时，它将 IPv4 地址转换为 IPv6 地址的形式。

- **工作原理**：
    - **DNS64** 通过将 IPv4 地址转换成符合 IPv6 地址格式的地址（通常通过前缀）来实现 IPv6-only 网络和 IPv4-only 网络的互操作性。
    - 设备可以通过 **NAT64** 进行 IPv6 到 IPv4 的转换。
- **优点**：
    - 使 IPv6-only 网络能够访问 IPv4 内容。
    - 不需要在 IPv4-only 网络中部署 IPv6 地址。
- **缺点**：
    - 依赖于 NAT64 和 DNS64 配置，这可能会导致一些网络性能问题。

### DNS 查询和递归解析

- **递归查询**：在一些情况下，设备使用递归 DNS 服务器来查询目标域名。递归服务器会从根服务器开始，直到找到最终的 DNS 记录（如 A 记录或 AAAA 记录），并将结果返回给设备。
- 工作原理
    1. 设备将查询请求发送到配置的 DNS 服务器。
    2. 如果 DNS 服务器没有缓存该域名的解析记录，它会向其他 DNS 服务器查询，直到找到最终的解析结果。
    3. 设备收到解析结果并返回。

## 相关协议

### ICMPv6 (Internet Control Message Protocol for IPv6)

#### 功能

ICMPv6 是 IPv6 网络中的控制消息协议，负责发送错误报告、诊断和网络测试。

#### 工作原理

![img](http://public.file.lvshuhuai.cn/images\v2-8c9eae2399343c83d9e01f625fd6674e_1440w.jpg)

ICMPv6 包括 **Echo Request/Reply**（类似于 ping 命令）用于网络诊断，还包括 **Destination Unreachable** 和 **Time Exceeded** 等错误消息。

ICMPv6 还包括 **Router Advertisement** 和 **Router Solicitation**，用于路由器发现和网络配置。

### 邻居发现协议（NDP, Neighbor Discovery Protocol）

#### 功能

NDP 是 IPv6 网络中用于设备发现和地址解析的协议，类似于 IPv4 中的 ARP（Address Resolution Protocol）。

#### 工作原理

NDP 使用 ICMPv6 消息（如 **邻居请求（Neighbor Solicitation）** 和 **邻居通告（Neighbor Advertisement）**）来识别和验证设备的物理地址（MAC 地址）。

NDP 还用于检测网络中其他设备的连通性，保障通信的安全性。

### MTU (Maximum Transmission Unit) 发现

#### 功能：

IPv6 协议允许通过 **Path MTU Discovery** 算法动态发现路径上的最大传输单元（MTU）。

#### 工作原理

设备通过发送 **ICMPv6 Fragmentation Needed** 消息来告知数据包大小超过网络的 MTU，要求发送方减小数据包大小。