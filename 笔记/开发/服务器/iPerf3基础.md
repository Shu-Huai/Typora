# iPerf3 基础

iPerf3 是一个 TCP、UDP 和 SCTP 网络带宽测量工具。可用于主动测量 IP 网络上可达到的最大带宽的工具。它支持调整与时序，协议和缓冲区有关的各种参数。对于每个测试，它都会报告测得的吞吐量 / 比特率，损耗和其他参数。

## 基本信息

**iPerf3** 是一种流行的网络性能测试工具，用于测量网络带宽、吞吐量和其他相关性能指标。

官方的 HomePage：[iPerf - The TCP, UDP and SCTP network bandwidth measurement tool](https://iperf.fr/)，可在其中找到一些介绍和下载内容。

iPerf3 是开源的，Github 地址：[esnet/iperf: iperf3: A TCP, UDP, and SCTP network bandwidth measurement tool](https://github.com/esnet/iperf)

iPerf3 使用 C 语言进行开发，具有高性能、可移植性、直接面向操作系统内核等优势。

## 主要特点

1. **客户端-服务器模型**

   iPerf3 基于客户端和服务器架构工作，允许用户通过一个客户端发送数据流到服务器，从而测量网络性能。

2. **多种传输协议支持**

   iPerf3 支持 TCP、UDP 和 SCTP 协议，适用于多种网络环境和测试需求。

3. **单线程设计**

   与 iPerf2 不同，iPerf3 使用单线程设计，从而简化了测试环境，同时保持高效。

4. **详细报告**

   iPerf3 会生成详细的测试报告，包括带宽、数据包丢失、延迟（Jitter）等性能指标。

5. **可控的传输参数**

   用户可以设置各种参数，例如数据流持续时间、窗口大小、并发流数量等，提供极大的灵活性。

6. **跨平台支持**

   iPerf3 是开源软件，可运行在 Linux、Windows、macOS 和 FreeBSD 等操作系统上。

## 与 iPerf2 的区别

### 开发背景

| **特性**     | **iPerf2**                    | **iPerf3**                               |
| ------------ | ----------------------------- | ---------------------------------------- |
| **开发团队** | 原由 NLANR 开发（后停止更新） | ESnet（Energy Sciences Network）重新开发 |
| **开发状态** | 停止维护，功能基本固定        | 持续维护和更新，定期推出新版本           |
| **设计目标** | 最初用于简单网络性能测试      | 重新设计，更注重可扩展性和灵活性         |

### 2. 功能特性

| **功能**           | **iPerf2**                         | **iPerf3**                           |
| ------------------ | ---------------------------------- | ------------------------------------ |
| **多线程支持**     | 支持多线程（客户端和服务器端可用） | 单线程设计，简化逻辑，提高稳定性     |
| **协议支持**       | TCP 和 UDP                         | TCP、UDP 和 SCTP                     |
| **吞吐量统计**     | 基本统计（带宽、丢包率等）         | 更详细的统计（如 Jitter、RTT 等）    |
| **带宽限制**       | 支持基本的带宽限制                 | 带宽限制功能更灵活，支持更精确的设置 |
| **报告格式**       | 简单输出                           | 提供 JSON 格式的输出，便于脚本解析   |
| **服务端运行模式** | 持续运行                           | 持续运行，也可设置最大测试连接数     |
| **插件和扩展**     | 不支持                             | 支持添加插件，便于扩展功能           |

### 3. 性能和架构

| **特性**     | **iPerf2**                 | **iPerf3**                       |
| ------------ | -------------------------- | -------------------------------- |
| **线程模型** | 多线程架构，易引入竞争条件 | 单线程架构，避免多线程同步问题   |
| **负载处理** | 对高负载的测试支持较弱     | 对高带宽和高负载网络有更好的优化 |
| **稳定性**   | 在复杂网络条件下稳定性较差 | 提升了在各种网络条件下的稳定性   |
| **兼容性**   | 不兼容 iPerf3              | 向后不兼容，完全重新设计         |

### 4. 常用参数对比

| **参数/特性**    | **iPerf2**                   | **iPerf3**                           |
| ---------------- | ---------------------------- | ------------------------------------ |
| **默认端口**     | 5001                         | 5201                                 |
| **多流支持**     | 需要显式指定                 | 默认支持多流传输                     |
| **测试持续时间** | 通过 `-t` 设置（默认 10 秒） | 通过 `-t` 设置（默认 10 秒）         |
| **带宽限制**     | 使用 `-b` 限制带宽           | 使用 `-b` 限制带宽，支持更精确的限制 |
| **协议选择**     | `-u` 切换到 UDP              | `-u` 切换到 UDP，支持 SCTP           |

### 5. 使用场景

| **适用场景**       | **iPerf2**               | **iPerf3**                   |
| ------------------ | ------------------------ | ---------------------------- |
| **基础网络测试**   | 可满足基本需求           | 支持更详细的测试和分析       |
| **高带宽链路测试** | 性能可能不足             | 对高带宽网络表现更好         |
| **自动化脚本集成** | 无标准化输出，集成较困难 | 支持 JSON 格式输出，便于集成 |
| **定期维护和支持** | 停止更新，不建议使用     | 持续更新，适合长期使用       |

## 安装

### 在 Linux（Ubuntu）上安装

运行

```bash
sudo apt-get install iperf3
```

### 在 Windows 上安装

在官网 [iPerf - Download iPerf3 and original iPerf pre-compiled binaries](https://iperf.fr/iperf-download.php) 上下载属于 Windows 的二进制文件，解压后在终端中运行。

建议将解压缩路径添加到环境变量中。

## 基本使用

iPerf3 是 C/S 架构的，在使用时需要在服务端和客户端启动

### 服务端启动

```bash
iperf3 -s
```

<img src="http://public.file.lvshuhuai.cn/images\image-20241207161132283.png" alt="image-20241207161132283" style="zoom:50%;" />

### 客户端启动

```bash
iperf3 -c <server-ip>
```

<img src="http://public.file.lvshuhuai.cn/images\image-20241207161646352.png" alt="image-20241207161646352" style="zoom:50%;" />

## 常用参数

| 参数 | 中文说明                                                     |
| ---- | ------------------------------------------------------------ |
| `-s` | 表示服务器端；                                               |
| `-p` | 定义端口号                                                   |
| `-i` | 设置每次报告之间的时间间隔，单位为秒，如果设置为非零值，就会按照此时间间隔输出测试报告，默认值为零 |
| `-c` | 表示服务器的IP地址；                                         |
| `-t` | 指定传输测试的持续时间,Iperf在指定的时间内，重复的发送指定长度的数据包，默认是10秒钟 |
| `-w` | 设置套接字缓冲区为指定大小，对于TCP方式，此设置为TCP窗口大小，对于UDP方式，此设置为接受UDP数据包的缓冲区大小，限制可以接受数据包的最大值. |
| `-J` | 来输出JSON格式测试结果.                                      |
| `-R` | 反向传输,缺省iperf3使用上传模式：Client负责发送数据，Server负责接收；如果需要测试下载速度，则在Client侧使用-R参数即可 |

## 参数大全

### 通用参数（服务器或客户端）

| 参数                        | 中文说明                                                     |
| --------------------------- | ------------------------------------------------------------ |
| `-p, --port #`              | 指定服务器监听或客户端连接的端口号                           |
| `-f, --format [kmgtKMGT]`   | 设置报告的单位格式：Kbits, Mbits, Gbits, Tbits               |
| `-i, --interval #`          | 设置定期显示吞吐量报告的时间间隔（单位：秒）                 |
| `-I, --pidfile file`        | 将进程 ID 写入指定的文件                                     |
| `-F, --file name`           | 指定文件以发送/接收                                          |
| `-A, --affinity n/n,m`      | 设置 CPU 亲和性                                              |
| `-B, --bind <host>[%<dev>]` | 绑定到与地址 `<host>` 关联的接口（可选的 `<dev>` 等效于 `--bind-dev <dev>`） |
| `--bind-dev <dev>`          | 绑定到网络接口（使用 SO_BINDTODEVICE）                       |
| `-V, --verbose`             | 输出详细信息                                                 |
| `-J, --json`                | 输出 JSON 格式的测试结果                                     |
| `--logfile f`               | 将输出写入指定的日志文件                                     |
| `--forceflush`              | 在每个时间间隔后强制刷新输出                                 |
| `--timestamps<=format>`     | 每行输出开头添加时间戳（可选的 `=` 和格式字符串基于 strftime(3)） |
| `--rcv-timeout #`           | 设置接收数据的空闲超时时间（默认 120,000 毫秒）              |
| `--snd-timeout #`           | 设置未确认的 TCP 数据的超时时间（单位：毫秒，默认为系统设置） |
| `-d, --debug[=#]`           | 输出调试信息（可选 `=` 和调试级别：1-4，默认是 4 - 全部消息） |
| `-v, --version`             | 显示版本信息并退出                                           |
| `-h, --help`                | 显示帮助信息并退出                                           |

### 服务器专用参数

| 参数                                | 中文说明                                                     |
| ----------------------------------- | ------------------------------------------------------------ |
| `-s, --server`                      | 启动服务器模式                                               |
| `-D, --daemon`                      | 将服务器以守护进程模式运行                                   |
| `-1, --one-off`                     | 仅处理一个客户端连接后退出                                   |
| `--server-bitrate-limit #[KMG][/#]` | 设置服务器总比特率限制（默认 0 = 无限制，可选 `/` 和秒数间隔，默认为 5 秒） |
| `--idle-timeout #`                  | 设置服务器空闲超时时间（单位：秒，默认无超时）               |
| `--rsa-private-key-path`            | 指定用于解密认证凭据的 RSA 私钥路径                          |
| `--authorized-users-path`           | 指定包含用户凭据的配置文件路径                               |
| `--time-skew-threshold`             | 在认证过程中设置服务器与客户端之间的时间偏差阈值（单位：秒） |

### 客户端专用参数

| 参数                          | 中文说明                                                     |
| ----------------------------- | ------------------------------------------------------------ |
| `-c, --client <host>[%<dev>]` | 启动客户端模式，连接到指定的 `<host>`（可选的 `<dev>` 等效于 `--bind-dev <dev>`） |
| `--sctp`                      | 使用 SCTP 协议代替 TCP                                       |
| `-X, --xbind <name>`          | 将 SCTP 会话绑定到特定链接                                   |
| `--nstreams #`                | 设置 SCTP 流的数量                                           |
| `-u, --udp`                   | 使用 UDP 协议代替 TCP                                        |
| `--connect-timeout #`         | 设置控制连接的超时时间（单位：毫秒）                         |
| `-b, --bitrate #[KMG][/#]`    | 设置目标比特率（默认 UDP 为 1 Mbit/s，TCP 无限制，可选 `/` 表示突发模式包数） |
| `--pacing-timer #[KMG]`       | 设置流量控制计时器（单位：微秒，默认 1000）                  |
| `--fq-rate #[KMG]`            | 启用基于公平队列的套接字流量控制（仅限 Linux，单位：bits/sec） |
| `-t, --time #`                | 设置传输时间（单位：秒，默认 10 秒）                         |
| `-n, --bytes #[KMG]`          | 指定要传输的字节数（代替 `-t`）                              |
| `-k, --blockcount #[KMG]`     | 指定要传输的包块数（代替 `-t` 或 `-n`）                      |
| `-l, --length #[KMG]`         | 设置缓冲区的读写长度（默认 TCP 为 128 KB，UDP 为动态或 1460） |
| `--cport <port>`              | 设置客户端端口（默认使用动态端口）                           |
| `-P, --parallel #`            | 设置并发流的数量                                             |
| `-R, --reverse`               | 反向模式测试（服务器发送，客户端接收）                       |
| `--bidir`                     | 双向模式测试（客户端和服务器同时发送和接收数据）             |
| `-w, --window #[KMG]`         | 设置发送/接收套接字缓冲区大小（间接设置 TCP 窗口大小）       |
| `-C, --congestion <algo>`     | 设置 TCP 拥塞控制算法（仅限 Linux 和 FreeBSD）               |
| `-M, --set-mss #`             | 设置 TCP/SCTP 最大段大小（MTU - 40 字节）                    |
| `-N, --no-delay`              | 禁用 TCP/SCTP 的 Nagle 算法（启用低延迟）                    |
| `-4, --version4`              | 强制使用 IPv4                                                |
| `-6, --version6`              | 强制使用 IPv6                                                |
| `-S, --tos N`                 | 设置 IP 服务类型（ToS），范围为 0-255                        |
| `--dscp N or --dscp val`      | 设置 IP DSCP 值，可用数字（0-63）或符号表示法                |
| `-L, --flowlabel N`           | 设置 IPv6 流标签（仅限 Linux）                               |
| `-Z, --zerocopy`              | 使用“零拷贝”方式发送数据                                     |
| `-O, --omit N`                | 在测试前执行 N 秒预测试，省略预测试统计数据                  |
| `-T, --title str`             | 在每行输出前添加指定的标题                                   |
| `--extra-data str`            | 在客户端和服务器 JSON 中包含额外的数据字符串                 |
| `--get-server-output`         | 获取服务器的测试结果                                         |
| `--udp-counters-64bit`        | 在 UDP 测试中使用 64 位计数器                                |
| `--repeating-payload`         | 在负载中使用重复模式而不是随机化负载（类似于 iperf2）        |
| `--dont-fragment`             | 设置 IPv4 的“不分片”标志                                     |
| `--username`                  | 指定用于认证的用户名                                         |
| `--rsa-public-key-path`       | 指定用于加密认证凭据的 RSA 公钥路径                          |