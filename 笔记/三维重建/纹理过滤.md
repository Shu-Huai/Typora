# 纹理过滤

纹理过滤（Texture Filtering）是计算机图形学中的一个重要概念，主要用于在 3D 图形渲染过程中，处理纹理映射时如何从纹理图像中获取像素颜色值。

## 一、基本原理

当 3D 模型的表面被映射纹理时，模型表面的每个像素（也称为纹素）需要从纹理图中获取相应的颜色信息。然而，由于 3D 模型表面的像素位置和纹理图的像素位置可能不完全匹配，就需要纹理过滤来确定最适合的颜色值。

例如，一个简单的情况是，当一个三角形面片在屏幕空间中的尺寸比它所对应的纹理部分大时，就需要对纹理进行放大；反之，当三角形面片比纹理部分小时，就需要对纹理进行缩小。

## 二、主要过滤方式

### 最近邻过滤（Nearest - Neighbor Filtering）

这是最简单的纹理过滤方式。在进行纹理采样时，它会选择距离采样点最近的纹理像素（纹素）的颜色值。

例如，当需要对一个纹理进行放大时，这种方法可能会导致明显的块状或锯齿状的视觉效果。因为它只是简单地选择最近的纹素，而没有考虑周围纹素的颜色过渡。就好像用一个个方块去拼凑放大后的纹理，在方块的边界处会有很明显的不连续。

### 线性过滤（Linear Filtering）

线性过滤在放大或缩小纹理时会考虑采样点周围的纹素。在放大纹理时，它会根据采样点周围纹素的颜色进行加权平均来得到采样点的颜色。

例如，对于一个二维纹理，当采样点位于四个纹素中间时，它会根据这四个纹素的颜色以及采样点到每个纹素的距离来计算一个加权平均的颜色值。这样可以得到更平滑的放大效果，避免了最近邻过滤那种明显的块状感。在缩小纹理时，它也会通过类似的加权平均方式来选择合适的颜色，减少纹理的混叠现象。

### 各向异性过滤（Anisotropic Filtering）

各向异性过滤是一种更高级的纹理过滤技术。在处理斜向观察纹理表面或者纹理在不同方向上有不同程度的拉伸时非常有效。

例如，当观察一个斜着的纹理平面时，线性过滤可能会使纹理变得模糊，因为它在水平和垂直方向上同等地考虑纹素。而各向异性过滤会考虑纹理在不同方向上的拉伸情况，沿着拉伸方向采样更多的纹素来获取更准确的颜色信息，从而使纹理在不同角度观察时都能保持清晰和准确的外观。它能够更好地还原纹理的细节，特别是在处理诸如地面纹理、远处倾斜的墙壁纹理等场景时效果显著。

## 应用场景

纹理过滤广泛应用于 3D 游戏、虚拟现实（VR）、增强现实（AR）以及计算机辅助设计（CAD）等领域。在 3D 游戏中，它可以让游戏中的角色、场景、道具等物体的纹理看起来更加真实和细腻。比如在一款赛车游戏中，赛道地面的纹理如果采用合适的纹理过滤方式，能够在不同的视角和赛车行驶状态下都保持良好的视觉效果，让玩家有更好的游戏体验。在 CAD 软件中，准确的纹理过滤有助于设计师更好地预览产品模型的外观，特别是对于有复杂纹理表面的产品。

## 双线性过滤

### 定义

双线性过滤（Bilinear Filtering）是一种纹理过滤（Texture Filtering）技术。在计算机图形学中，当将纹理映射到三维物体表面时，需要确定纹理图像中的像素（纹理元素，简称纹素，texel）如何对应到屏幕上的像素。双线性过滤用于在采样纹理时，对相邻的纹素进行加权平均，以获得更平滑的纹理映射效果。

### 工作原理

考虑一个屏幕像素，它在纹理空间中的位置可能不是正好对应一个纹素。双线性过滤会在纹理空间中找到这个像素对应的位置周围的四个纹素。假设这个位置的坐标是 $(u,v)$，周围的四个纹素坐标分别是 $(i, j)$、$(i + 1,j)$、$(i,j + 1)$ 和 $(i + 1,j + 1)$，其中 $i$ 和 $j$ 是整数部分，小数部分用于计算权重。

首先，在水平方向（$u$ 轴）上对两个纹素对进行线性插值。例如，对于纹素 $(i, j)$ 和 $(i + 1,j)$，根据 $u$ 的小数部分（设为 $u_f$）计算插值结果 $A$：

$$A=(1 - u_f)\times texel(i, j)+u_f\times texel(i + 1,j)$$

同样，对于纹素$(i,j + 1)$和$(i + 1,j + 1)$，计算插值结果$B$：

$$B=(1 - u_f)\times texel(i,j + 1)+u_f\times texel(i + 1,j + 1)$$

然后，在垂直方向（$v$轴）上对$A$和$B$进行线性插值，根据$v$的小数部分（设为$v_f$）计算最终结果$C$：

$$C=(1 - v_f)\times A+v_f\times B$$

### 与其他过滤方式的比较

**最近邻过滤（Nearest - Neighbor Filtering）**

最近邻过滤是一种简单的纹理过滤方法。它直接选择距离采样点最近的纹素作为采样结果。这种方法计算速度快，但会导致纹理在缩放时出现锯齿状的边缘，视觉效果比较粗糙。例如，当一个纹理被放大时，像素会直接复制最近纹素的颜色，没有过渡。

**双线性过滤优势**

双线性过滤通过考虑周围纹素的加权平均，有效地减少了纹理缩放时的锯齿现象，使纹理在不同分辨率下都能有相对平滑的过渡。与最近邻过滤相比，双线性过滤在视觉质量上有明显的提升，尤其是在纹理需要拉伸或缩小的情况下。

**双线性过滤的局限性和三线性过滤（Trilinear Filtering）**

双线性过滤的一个局限性是它只考虑了二维纹理空间中的相邻纹素。当纹理在三维空间中（例如，具有多个细节层次的纹理）被采样时，双线性过滤可能无法提供足够好的效果。三线性过滤在双线性过滤的基础上，考虑了不同细节层次（Mipmap）之间的过渡，进一步提高了纹理映射的质量。

### 应用场景

**游戏开发**

在 3D 游戏中广泛应用。例如，在渲染游戏场景中的墙壁、地面等物体表面纹理时，双线性过滤可以使纹理看起来更加自然。像在一款角色扮演游戏中，角色行走在带有纹理的地面上，双线性过滤可以让地面纹理在不同视角和距离下都能保持较好的视觉效果，避免纹理出现明显的失真。

**虚拟现实（VR）和增强现实（AR）**

VR和AR应用需要高质量的纹理映射来提供逼真的视觉体验。双线性过滤有助于减少纹理的锯齿感，提高虚拟环境和增强现实元素的真实感。例如，在一个 VR 建筑漫游应用中，建筑表面的纹理使用双线性过滤可以让用户感觉更加身临其境。

**计算机辅助设计（CAD）和 3D 建模软件**

当渲染 3D 模型的表面纹理时，双线性过滤可以改善纹理的外观。比如在汽车设计软件中，汽车外观的纹理（如车漆纹理、内饰纹理等）通过双线性过滤能够更平滑地显示，帮助设计师更好地评估设计效果。

## 三线性过滤

### 基本原理

三线性过滤结合了双线性过滤和 Mipmap 技术 。Mipmap 是一系列预先计算好的、分辨率逐渐降低的纹理图像，当纹理需要缩小时，OpenGL 等图形库会根据纹理在屏幕上的显示大小选择合适分辨率的 Mipmap 级别 。

三线性过滤会在两个最接近的 Mipmap 级别上进行双线性过滤，然后再对这两个双线性过滤的结果进行线性插值，从而得到最终的像素颜色值 。

### 具体操作过程

1. 选择合适的 Mipmap 级别：根据纹理在屏幕上的投影大小，确定最接近的两个 Mipmap 级别。例如，如果纹理在屏幕上显示得较小，就会选择较低分辨率的两个 Mipmap 级别；如果显示得较大，则选择较高分辨率的两个级别
2. 双线性过滤：对选定的两个 Mipmap 级别中的每一个级别，都使用双线性过滤来计算一个临时的像素值。双线性过滤是通过对纹理中相邻的四个像素进行加权平均来得到更平滑的颜色过渡，即在二维空间上进行线性差值来得到像素的混合值
3. 线性插值：在得到两个 Mipmap 级别经过双线性过滤后的像素值后，再根据纹理在两个级别之间的权重，对这两个值进行线性插值，得到最终用于显示的像素颜色值

### 优点

- 纹理过渡平滑：有效地减轻或消除了不同组合等级纹理过渡时出现的组合交叠现象，使纹理在不同分辨率之间的切换更加自然、平滑，减少了因分辨率变化而产生的锯齿和闪烁等瑕疵，从而提高了图像的视觉质量，尤其在处理具有不同深度或距离的纹理时效果显著
- 提升视觉真实感：能够更好地模拟真实世界中物体的纹理变化，让场景更加逼真。比如在渲染一个具有远近不同纹理细节的三维场景时，远处的纹理经过三线性过滤后不会出现明显的块状或模糊现象，与近处的纹理过渡自然，增强了整体画面的真实感。

### 缺点

- 计算成本较高：由于需要对两个 Mipmap 级别进行双线性过滤，并再进行一次线性插值，相比简单的过滤方法，计算量大幅增加。这可能会导致渲染速度变慢，特别是在处理复杂场景或低性能硬件设备时，性能下降较为明显
- 内存占用增加：使用三线性过滤通常需要存储多个 Mipmap 级别纹理，相比只存储原始纹理，会占用更多的内存空间。这对于内存资源有限的设备来说可能会成为一个问题，例如一些移动设备或低端计算机

### 应用场景

- 游戏开发：广泛应用于各种类型的游戏中，以提升游戏画面的质量和真实感。如第一人称射击游戏、角色扮演游戏等，能够使游戏中的场景、角色、道具等纹理更加细腻、自然，为玩家带来更好的视觉体验
- 3D 建模与动画：在 3D 建模软件和动画制作中，用于渲染高质量的模型和动画。可以让模型的纹理细节在不同视角和距离下都保持良好的表现，使动画的播放更加流畅、自然。
- 虚拟现实与增强现实：对于需要高沉浸感的虚拟现实和增强现实应用来说，三线性过滤有助于提高虚拟环境和虚拟物体的真实感，减少因纹理问题导致的视觉不适，让用户更加身临其境地感受虚拟世界。

## 各向异性过滤

### 各向同性与各向异性

#### 各向异性（Anisotropy）

在计算机图形学等领域，各向异性是指材料或物体的属性在不同方向上表现出不同的特性。

在纹理映射中，各向异性过滤（Anisotropic Filtering）是一种用于提高纹理质量的技术。当以一个倾斜的角度观察一个纹理表面时（比如从一个斜角观察有纹理的地面），如果没有各向异性过滤，纹理会变得模糊。这是因为传统的纹理过滤方法（如双线性过滤和三线性过滤）假设纹理在各个方向上的变化是均匀的，也就是各向同性的。但是实际情况中，纹理在不同方向上的变化是不同的，比如地面上的木纹纹理，沿着木纹方向和垂直于木纹方向的细节变化是不一样的。各向异性过滤会考虑观察角度和纹理方向之间的差异，在不同方向上采用不同程度的过滤，从而使纹理在倾斜视角下也能保持清晰的细节。

在计算机模拟的物理材料中，某些材料的导电性、导热性等物理属性可能是各向异性的。例如，液晶显示器（LCD）中的液晶材料，其光学性质在不同方向上是不同的。液晶分子的排列方式使得光线在平行于分子排列方向和垂直于分子排列方向上的传播特性不同，这种各向异性的光学性质被用于控制显示器的显示效果。

#### 各向同性（Isotropy）

与各向异性相反，各向同性是指物体的属性在所有方向上都是相同的。

在简单的图形渲染中，早期的基本纹理过滤方法（如最邻近过滤）在某种程度上假设了纹理是各向同性的。它以一种简单的方式从纹理中获取像素颜色，没有考虑观察角度对纹理外观的影响，默认纹理在各个方向上的细节和变化是均匀的。

在计算机模拟的理想气体中，分子的运动在统计意义上是各向同性的。假设没有外力作用，气体分子向各个方向运动的概率是相同的，分子间的碰撞在各个方向上也具有相同的概率分布，这种各向同性的运动特性是许多气体

### 定义

各向异性过滤（Anisotropic Filtering，简称AF）是一种 3D 显示技术，它是对周围各个方向上的像素进行取样计算后映射到目标像素上的技术

### 原理
与双线性过滤和三线性过滤不同，各向异性过滤会参考一个 pixel(x:y=1:1) 对应到纹理空间中在 $u$ 和 $v$ 方向上 $u$ 和 $v$ 的比例关系 。当 $u:v$ 不为 $1:1$ 时，将会按照比例在各方向上采样不同数量的点来计算最终结果

其过滤单元不是“四四方方”的，典型单元是矩形，还可以变形为梯形和平行四边形，以此来保证准确的透视关系和透明度，避免在某个轴上的纹理部分有大量信息，或是某个方向上的图象和纹理有个倾角时，导致最终纹理变得滑稽、比例失调的问题

### 作用
**提升画面质量**：在3D游戏等场景中，能够使画面更加逼真。特别是在处理大角度显示方面具有更高的精度，比如在游戏中观察远处的景物、物体的边缘纹理等时，能让纹理细节更加清晰，减少模糊感，使画面效果更为出色

**优化视觉效果**：可以消除因智能视觉贴图造成的部分相对不重要的视觉部分减少精度的问题，从而提升整体的视觉体验

### 实现方式
在 OpenGL 扩展规范中，各向异性过滤的实现方式被详细说明，通过定义一系列的数学符号和公式，可以计算出各向异性的比例，并在特定的 mipmap 层级取样

### 性能影响
**消耗硬件资源**：各向异性过滤需要对映射点周围较多的像素进行取样，相比双线性过滤和三线性过滤，它对显存带宽以及像素填充率的消耗更大，对显卡的性能要求更高。随着各向异性过滤级别的提高，对显卡的消耗也会相应增大，可能导致运行游戏时的帧数减少，尤其对于中低端显卡用户，可能会出现卡顿和掉帧的情况.

**实际影响程度**：不过在实际应用中，它对于速度的影响程度相对全屏抗锯齿来说较小，而且并非所有的像素点都需要高度各向异性的处理，通常只有少量的点（小于 10%）需要，再加上相邻的像素点通常存在于缓存里面，通过优化可以在一定程度上减少资源消耗